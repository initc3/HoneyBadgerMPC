os: linux
dist: xenial
language: python
cache: pip
python: 3.7
sudo: true
services:
- docker
env:
  global:
    # Generated by running:
    # $ gem install travis
    # $ travis encrypt DOCKER_USER=<username> --add
    # $ travis encrypt DOCKER_PASS=<password> --add
    # These are needed for the `docker login` call to succeed.
    - secure: "J4SqqWBvK+n6GHHACzOyJfZWyoObHRp26QleFyywSt+l6r40QIIyBGBVxUzO2E5EHZCRlE640pbk1wYMFg6GIqHbaWOI7AjbLAmzMLOiIbRLd/y0BNntC6Gl8N/SWTA0JsiDd5/xOXTK2XPk/O0NfHZmHX9LajW9blXOyFlSKCy6sO093sRZJIH9bt6TkyQlpfDhp4bw63WRbekXvxXYVg0fK47n9h1/t5OqY/ppKECpN7K7/qRPtlwdfi0rB4Ud38PolW/qppBKPD19JdIIJFseDNA2k6HFDaw4WA1o5Sj0g1uY2aI6ST+6U7sC0hkf5x2EDei+WP5ktJvRi0Fk1baegUk/mel9+ZbBMIb/moYequBgZuee9xBPzVtiA2zzTIz2nd4PPC5TKtO7ZfLQI3cm9W59+lUMcZm2ZBE9HuWjt7KJvre3CwnO461g1P5KD+DOtn1Vpxk3QCUjxaUypXbOE4LsuZuqS+CkPIQ5fCqlLiH4zZEYBgU6KkupDfr3a27CbtuNfnsp/6/V2GHDEIlM2oMl1gez5EkdifRRMaDZYL7VyAX5e/Es7BkkCo+lF5ihKMVgUu1p71ZFO3VQ8uEhcCUnfXVSLJHiiCy20eYsPWP5rgESnL3qRF6+W0Q+9ak80ojFZdSe1ZHfJlG7cQQs9q8KTh4Y558YbkciXtw="
jobs:
  include:
  - stage: Linting
    name: Black
    install: pip install black
    script: black --check .
  - name: Flake8
    install: pip install flake8 pep8-naming
    script: flake8
  - name: Doc8
    install: pip install doc8 pygments
    script: doc8 docs/
  - stage: Build
    name: Build Docker Image for Current Commit
    install: pip install pyyaml
    before_script: bash scripts/docker_login.sh
    script: scripts/stager.py -vv build -t prod -c remote -b $TRAVIS_COMMIT --cache-tags $TRAVIS_COMMIT latest
    after_success: scripts/stager.py -vv push -t prod -b $TRAVIS_COMMIT
  - stage: Test
    name: Sphinx Tests
    install: pip install pyyaml
    # Not using `scripts/stager.py` as we only need the one image
    before_script: bash scripts/docker_image_pull.sh
    script: bash scripts/docker_doc_run.sh
    after_success: skip
  - name: Unit Tests
    install: pip install --upgrade codecov
    # Not using `scripts/stager.py` as we only need the one image
    before_script: bash scripts/docker_image_pull.sh
    # TODO: currently spits out errors on travis runs
    # See: https://travis-ci.org/initc3/HoneyBadgerMPC/jobs/560315742
    script: bash scripts/docker_test_run.sh
    after_success:
      - docker cp $(docker ps -alq --format "{{.Names}}"):/usr/src/HoneyBadgerMPC/coverage.xml .
      - codecov -v
  - stage: Upload
    if: type = push
    name: Tag and upload images to Dockerhub
    install: pip install pyyaml
    script: .ci/tag_and_upload.sh
    after_success: skip
